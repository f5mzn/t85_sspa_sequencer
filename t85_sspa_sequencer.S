; SSPA Sequencer
; (c) Olivier Le Cam <olecam@f5mzn.org>

#define PINB  0x16
#define DDRB  0x17
#define PORTB 0x18

#define PB0 0
#define PB1 1
#define PB2 2
#define PB3 3
#define PB4 4
#define PB5 5

#define DDB0 0
#define DDB1 1
#define DDB2 2
#define DDB3 3
#define DDB4 4
#define DDB5 5

#define PINB0 0
#define PINB1 1
#define PINB2 2
#define PINB3 3
#define PINB4 4
#define PINB5 5
  
  .global main

  ; Delay 50ms
  ; Assembly code auto-generated by utility from Bret Mulvey
  ; http://darcy.rsgc.on.ca/ACES/TEI4M/AVRdelay.html
  ; Delay 800 000 cycles for 50ms at 16.0 MHz
delay50ms:
  ldi  r18, 5
  ldi  r19, 15
  ldi  r20, 242
L1:
  dec  r20
  brne L1
  dec  r19
  brne L1
  dec  r18
  brne L1
  ret

  ;------------------------------------------------------------
  ; switching to transmit sequence
  ;------------------------------------------------------------
txon:
  sbi PORTB, PB2    ; switch relays on
  rcall delay50ms
  sbi PORTB, PB1    ; enable ldmos
  rcall delay50ms
  sbi PORTB, PB0    ; enable driver
  rcall delay50ms
  ret

  ;------------------------------------------------------------
  ; switching back to receive sequence
  ;------------------------------------------------------------
txoff:
  cbi PORTB, PB0    ; disable driver
  rcall delay50ms
  cbi PORTB, PB1    ; disable ldmos
  rcall delay50ms
  cbi PORTB, PB2    ; switch relays off
  rcall delay50ms
  ret

  ;------------------------------------------------------------
  ; Main function: program starts here
  ;------------------------------------------------------------
main:
  ; set pull up input on PB3
  ; set DDB3 (Pin 3) as input, others as output
  ldi r16, (1<<PB3)
  ldi r17, (1<<DDB4)|(1<<DDB2)|(1<<DDB1)|(1<<DDB0)
  out PORTB, r16
  out DDRB, r17

wait_tx:
  sbic PINB, PINB3  ; wait for PTT to be down (tx)
  rjmp wait_tx
  rcall txon

wait_rx:
  sbis PINB, PINB3  ; wait for PTT to be up (rx)
  rjmp wait_rx
  rcall txoff

  rjmp wait_tx
